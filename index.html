<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>frantalvin - Diagnostic Médical</title>
  <style>
    .bandeau {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: #007acc;
  color: white;
  padding: 8px 15px;
  border-radius: 10px;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --secondary: #f8fafc;
      --alert: #dc2626;
      --success: #16a34a;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.6;
      color: var(--text);
      background-color: #f1f5f9;
      padding: 0;
      -webkit-text-size-adjust: 100%;
    }
    
    .container {
      max-width: 100%;
      padding: 0;
    }
    
    header {
      background: var(--primary);
      color: white;
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .app-title {
      font-size: 1.25rem;
      font-weight: 500;
    }
    
    .tab-container {
      display: flex;
      background: white;
      position: sticky;
      top: 60px;
      z-index: 9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .tab {
      flex: 1;
      text-align: center;
      padding: 0.75rem;
      font-weight: 500;
      color: var(--text-light);
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .tab-content {
      display: none;
      padding: 1rem;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .panel {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      overflow: hidden;
    }
    
    .panel-header {
      background: var(--primary);
      color: white;
      padding: 0.75rem 1rem;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-content {
      padding: 1rem;
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text);
      font-size: 0.875rem;
    }
    
    input[type="text"],
    input[type="number"],
    textarea, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      font-family: inherit;
      font-size: 1rem;
      transition: border 0.2s;
      background-color: white;
    }
    
    input:focus, textarea:focus {
      border-color: var(--primary-light);
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .symptoms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    
    .symptom-item {
      display: flex;
      align-items: center;
      background: var(--secondary);
      padding: 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }
    
    .checkbox {
      margin-right: 0.5rem;
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 500;
      font-size: 1rem;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    button:hover {
      background: var(--primary-light);
    }
    
    button.secondary {
      background: #64748b;
    }
    
    button.success {
      background: var(--success);
    }
    
    button.danger {
      background: var(--alert);
    }
    
    #chat-container {
      height: 50vh;
      overflow-y: auto;
      padding: 1rem;
      background: var(--secondary);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .message {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: 85%;
      line-height: 1.5;
      position: relative;
      font-size: 0.9375rem;
      word-break: break-word;
    }
    
    .user-message {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    
    .bot-message {
      background: white;
      border: 1px solid var(--border);
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    #input-area {
      display: flex;
      padding: 0.75rem;
      background: white;
      border-top: 1px solid var(--border);
      gap: 0.75rem;
    }
    
    #user-input {
      flex-grow: 1;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 1.5rem;
      font-size: 1rem;
    }
    
    #send-btn {
      width: auto;
      padding: 0.75rem;
      border-radius: 50%;
      aspect-ratio: 1/1;
    }
    
    .typing-indicator {
      display: inline-flex;
      padding: 0.75rem 1rem;
      background: white;
      border-radius: 1rem;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .typing-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: var(--text-light);
      border-radius: 50%;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-0.25rem); }
    }
    
    .warning {
      font-size: 0.8125rem;
      color: var(--alert);
      padding: 0.75rem;
      text-align: center;
      background: #fee2e2;
      border-top: 1px solid #fecaca;
    }
    
    .result-section {
      padding: 1rem;
    }
    
    .diagnostic-card {
      background: #f0fdf4;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--success);
    }
    
    .diagnostic-card h3 {
      margin-top: 0;
      color: var(--success);
      font-size: 1.125rem;
      margin-bottom: 0.75rem;
    }
    
    .hidden {
      display: none;
    }
    
    .user-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .disease-item {
      background: white;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: 0.5rem;
      border-left: 4px solid var(--primary);
      display: flex;
      justify-content: space-between;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .disease-name {
      font-weight: 500;
      color: var(--primary);
      font-size: 0.9375rem;
    }
    
    .disease-symptoms {
      font-size: 0.8125rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }
    
    .delete-disease {
      color: var(--alert);
      cursor: pointer;
      background: none;
      border: none;
      font-size: 0.8125rem;
      padding: 0 0.5rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }
    
    /* Améliorations mobile */
    @media (max-width: 480px) {
      .symptoms-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      
      .user-info {
        grid-template-columns: 1fr;
      }
      
      #chat-container {
        height: 40vh;
      }
    }
    
    /* Animation pour les nouveaux éléments */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="app-title">Diagnostic pou tous</div>
   <div class="bandeau">ENIA 2.0</div>
    </header>
    
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('diagnostic')">Diagnostic</div>
      <div class="tab" onclick="switchTab('assistant')">Assistant</div>
      <div class="tab" onclick="switchTab('diseases')">Maladies</div>
    </div>
    
    <!-- Onglet Diagnostic -->
    <div id="diagnostic-tab" class="tab-content active">
      <div class="panel">
        <div class="panel-header">Formulaire de Diagnostic</div>
        <div class="panel-content">
          <div class="user-info">
            <div class="form-group">
              <label for="patient-age">Âge</label>
              <input type="number" id="patient-age" placeholder="Ex: 35" min="0" max="120">
            </div>
            
            <div class="form-group">
              <label for="patient-gender">Sexe</label>
              <select id="patient-gender">
                <option value="male">Masculin</option>
                <option value="female">Féminin</option>
                <option value="other">Autre</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="symptom-duration">Durée des symptômes</label>
            <div style="display:flex;align-items:center;gap:0.75rem;">
              <input type="number" id="symptom-duration" min="1" value="1" style="flex:1;">
              <select id="duration-unit" style="flex:2;">
                <option value="hours">Heures</option>
                <option value="days" selected>Jours</option>
                <option value="weeks">Semaines</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Symptômes principaux</label>
            <div class="symptoms-grid">
              <div class="symptom-item">
                <input type="checkbox" id="fever" value="fièvre" class="checkbox">
                <label for="fever">Fièvre</label>
              </div>
              <div class="symptom-item">
                <input type="checkbox" id="headache" value="maux de tête" class="checkbox">
                <label for="headache">Maux tête</label>
              </div>
              <div class="symptom-item">
                <input type="checkbox" id="cough" value="toux" class="checkbox">
                <label for="cough">Toux</label>
              </div>
              <div class="symptom-item">
                <input type="checkbox" id="fatigue" value="fatigue" class="checkbox">
                <label for="fatigue">Fatigue</label>
              </div>
              <div class="symptom-item">
                <input type="checkbox" id="nausea" value="nausées" class="checkbox">
                <label for="nausea">Nausées</label>
              </div>
              <div class="symptom-item">
                <input type="checkbox" id="pain" value="douleurs" class="checkbox">
                <label for="pain">Douleurs</label>
              </div>
              <div class="symptom-item">
                <input type="checkbox" id="breathing" value="difficultés respiratoires" class="checkbox">
                <label for="breathing">Respiration</label>
              </div>
              <div class="symptom-item">
                <input type="checkbox" id="rash" value="éruption cutanée" class="checkbox">
                <label for="rash">Éruption</label>
              </div>
            </div>
            <textarea id="other-symptoms" placeholder="Décrivez vos autres symptômes..." rows="2" style="margin-top: 0.75rem;"></textarea>
          </div>
          
          <div class="form-group">
            <label for="medical-history">Antécédents médicaux</label>
            <textarea id="medical-history" rows="2" placeholder="Maladies chroniques, allergies, médicaments..."></textarea>
          </div>
          
          <button id="diagnose-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L1 21h22L12 2zm0 4l7.53 13H4.47L12 6zm-1 4v4h2v-4h-2zm0 6v2h2v-2h-2z"/>
            </svg>
            Diagnostiquer
          </button>
          <button id="save-btn" class="success" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <path d="M17 21v-8H7v8M7 3v5h8"/>
            </svg>
            Enregistrer
          </button>
          <button id="clear-btn" class="secondary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Effacer
          </button>
        </div>
      </div>
      
      <div id="results" class="panel hidden">
        <div class="panel-header">Résultats du Diagnostic</div>
        <div class="panel-content">
          <div class="diagnostic-card" id="diagnostic-result">
            <!-- Les résultats apparaîtront ici -->
          </div>
          <div class="warning">
            ⚠️ Ces résultats sont indicatifs et ne remplacent pas une consultation médicale professionnelle.
          </div>
        </div>
      </div>
    </div>
    
    <!-- Onglet Assistant -->
    <div id="assistant-tab" class="tab-content">
      <div class="panel">
        <div class="panel-header">Assistant Médical IA</div>
        <div id="chat-container">
          <div class="bot-message message fade-in">
            Bonjour, je suis Dr. IA. Vous pouvez me décrire vos symptômes ou poser des questions médicales.
          </div>
        </div>
        <div id="input-area">
          <input type="text" id="user-input" placeholder="Décrivez vos symptômes ou posez une question...">
          <button id="send-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
          </button>
        </div>
        <div class="warning">
          ⚠️ En cas d'urgence vitale, contactez immédiatement un médecin (SAMU).
        </div>
      </div>
    </div>
    
    <!-- Onglet Maladies -->
    <div id="diseases-tab" class="tab-content">
      <div class="panel">
        <div class="panel-header">
          <span>Gestion des Maladies</span>
          <button onclick="toggleDiseaseForm()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
            + Ajouter
          </button>
        </div>
        
        <div id="disease-form" class="panel-content hidden" style="background: var(--secondary);">
          <div class="form-group">
            <label for="disease-name">Nom de la maladie</label>
            <input type="text" id="disease-name" placeholder="Ex: Paludisme">
          </div>
          
          <div class="form-group">
            <label for="disease-symptoms">Symptômes associés (séparés par des virgules)</label>
            <textarea id="disease-symptoms" rows="3" placeholder="Ex: fièvre, frissons, maux de tête"></textarea>
          </div>
          
          <button onclick="addDisease()" style="margin-right: 0.5rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <path d="M17 21v-8H7v8M7 3v5h8"/>
            </svg>
            Enregistrer
          </button>
          <button onclick="toggleDiseaseForm()" class="secondary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Annuler
          </button>
        </div>
        
        <div id="diseases-list" class="panel-content">
          <!-- Liste des maladies apparaîtra ici -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== BASE DE CONNAISSANCES ENRICHIE ====================
    const medicalKB = {
      // Symptômes courants
      "fièvre": {
        description: "Température corporelle > 38°C (100.4°F)",
        causes: [
          "Infection virale (60-70%) - Grippe, COVID-19, Rhume",
          "Infection bactérienne (15-20%) - Angine, Pneumonie, Infection urinaire",
          "Maladies inflammatoires (5-10%) - Arthrite, Maladie de Crohn",
          "Autres (5-10%) - Réaction médicamenteuse, Cancer"
        ],
        actions: [
          "Surveiller la température toutes les 4-6 heures",
          "Hydratation abondante (eau, bouillons)",
          "Paracétamol si > 38.5°C (sauf contre-indication)",
          "Repos"
        ],
        urgent: "Si > 40°C ou persistant > 48h ou avec raideur de nuque"
      },
      
      "maux de tête": {
        description: "Douleur au niveau du crâne, d'intensité variable",
        types: [
          "Céphalée de tension (75%) - Douleur en casque, stress",
          "Migraine (12%) - Unilatérale, pulsatile, avec nausées",
          "Sinusite (5%) - Douleur frontale, aggravée en penchant la tête",
          "Cluster (1%) - Douleur orbitaire très intense"
        ],
        actions: [
          "Repos dans un endroit calme et sombre",
          "Hydratation",
          "Analgésiques (paracétamol, ibuprofène si pas de contre-indication)",
          "Compresse froide sur le front"
        ],
        urgent: "Si soudain et violent (coup de tonnerre) ou avec troubles neurologiques"
      },
      
      "toux": {
        description: "Réflexe expiratoire brutal pour dégager les voies respiratoires",
        types: [
          "Toux sèche (irritative) - Allergie, COVID-19, Reflux",
          "Toux grasse (productive) - Bronchite, Pneumonie",
          "Toux chronique (>8 semaines) - Asthme, BPCO, Médicaments (IEC)"
        ],
        actions: [
          "Hydratation abondante",
          "Miel pour les toux irritatives (déconseillé avant 1 an)",
          "Humidification de l'air",
          "Éviter les irritants (tabac, parfums)"
        ],
        urgent: "Si crachats sanglants ou difficultés respiratoires"
      },
      
      // Maladies courantes
      "grippe": {
        description: "Infection virale saisonnière à influenza",
        symptoms: ["fièvre élevée", "frissons", "courbatures", "fatigue intense", "toux sèche"],
        incubation: "1-4 jours",
        duration: "5-7 jours (fatigue peut persister 2-3 semaines)",
        treatment: [
          "Repos",
          "Hydratation",
          "Antipyrétiques (paracétamol)",
          "Antiviraux (oseltamivir) dans certains cas"
        ],
        prevention: "Vaccination annuelle recommandée"
      },
      
      "COVID-19": {
        description: "Maladie infectieuse due au coronavirus SARS-CoV-2",
        symptoms: ["fièvre", "toux", "fatigue", "perte goût/odorat", "difficultés respiratoires"],
        variants: ["Omicron (dominant)", "Delta", "Alpha"],
        treatment: [
          "Isolement 7-10 jours",
          "Traitement symptomatique",
          "Antiviraux (nirmatrelvir/ritonavir) pour les cas à risque"
        ],
        tests: ["PCR (gold standard)", "Test antigénique", "Autotest"],
        urgent: "Si saturation < 92% ou détresse respiratoire"
      },
      
      "hypertension": {
        description: "Pression artérielle > 140/90 mmHg à plusieurs reprises",
        risks: ["AVC", "Infarctus", "Insuffisance rénale", "Rétinopathie"],
        management: [
          "Régime pauvre en sel",
          "Activité physique régulière",
          "Poids santé",
          "Médication si nécessaire (inhibiteurs calciques, IEC, etc.)"
        ],
        monitoring: "Automesure tensionnelle recommandée"
      },
      
      // Urgences médicales
      "AVC": {
        description: "Accident Vasculaire Cérébral (ischémique ou hémorragique)",
        symptoms: ["FAST - Face (asymétrie), Arm (faiblesse), Speech (trouble), Time (urgence)"],
        actions: [
          "APPELER LE 15 IMMÉDIATEMENT",
          "Noter l'heure de début des symptômes",
          "Ne pas donner à manger/boire",
          "Allonger le patient"
        ],
        golden_hour: "Traitement possible dans les 4h30 pour AVC ischémique"
      },
      
      "infarctus": {
        description: "Obstruction d'une artère coronaire",
        symptoms: ["douleur thoracique intense", "sueurs", "nausées", "irradiation bras gauche/mâchoire"],
        actions: [
          "APPELER LE 15 IMMÉDIATEMENT",
          "Aspirine 300mg à mâcher (si pas d'allergie)",
          "Repos absolu",
          "Défibrillateur accessible"
        ],
        time_is_muscle: "Chaque minute compte pour sauver le myocarde"
      }
    };

    // ==================== SYSTÈME COMPLET ====================
    // 1. Authentification utilisateur
    const currentUser = {
      id: 'user_' + Math.random().toString(36).substring(2, 10),
      name: 'Utilisateur',
      role: 'patient',
      lastLogin: new Date().toISOString()
    };
    
    // 2. Gestion des maladies
    const diseaseManager = {
      diseases: JSON.parse(localStorage.getItem('medicalDiseases')) || [
        { name: "Grippe", symptoms: ["fièvre", "toux", "fatigue", "courbatures"] },
        { name: "COVID-19", symptoms: ["fièvre", "toux", "fatigue", "perte goût/odorat"] },
        { name: "Allergie saisonnière", symptoms: ["éternuements", "yeux qui piquent", "écoulement nasal"] },
        { name: "Hypertension", symptoms: ["maux de tête", "vertiges", "saignements de nez"] }
      ],
      
      save: function() {
        localStorage.setItem('medicalDiseases', JSON.stringify(this.diseases));
        this.refreshUI();
        diagnosticEngine.updateDiseases(this.diseases);
      },
      
      add: function(name, symptoms) {
        const newDisease = {
          name: name.trim(),
          symptoms: symptoms.split(',').map(s => s.trim()).filter(s => s),
          custom: true
        };
        
        this.diseases.push(newDisease);
        this.save();
        showNotification(`Maladie "${newDisease.name}" ajoutée`);
      },
      
      remove: function(index) {
        const removed = this.diseases.splice(index, 1)[0];
        this.save();
        showNotification(`Maladie "${removed.name}" supprimée`, 'warning');
      },
      
      refreshUI: function() {
        const listEl = document.getElementById('diseases-list');
        listEl.innerHTML = '';
        
        if (this.diseases.length === 0) {
          listEl.innerHTML = '<div class="empty-state">Aucune maladie enregistrée</div>';
          return;
        }
        
        this.diseases.forEach((disease, index) => {
          const diseaseEl = document.createElement('div');
          diseaseEl.className = 'disease-item fade-in';
          diseaseEl.innerHTML = `
            <div>
              <div class="disease-name">${disease.name}</div>
              <div class="disease-symptoms">${disease.symptoms.join(', ')}</div>
              ${disease.custom ? '<div style="font-size:0.7rem;color:#888;">(personnalisée)</div>' : ''}
            </div>
            <button class="delete-disease" onclick="diseaseManager.remove(${index})">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          `;
          listEl.appendChild(diseaseEl);
        });
      }
    };
    
    // 3. Système de diagnostic
    const diagnosticEngine = {
      diseases: [],
      
      updateDiseases: function(diseases) {
        this.diseases = diseases;
        console.log("Base de maladies mise à jour :", this.diseases);
      },
      
      analyze: function(symptoms, duration, history = '') {
        // Convertir la durée en jours
        const durationDays = this.convertToDays(duration.value, duration.unit);
        
        // Analyse des symptômes
        const results = {
          possibleConditions: [],
          recommendations: [
            "Repos et hydratation",
            "Surveillance des symptômes"
          ],
          urgency: "Non urgent",
          warningSigns: []
        };
        
        // Détection des maladies correspondantes
        this.diseases.forEach(disease => {
          const matchScore = this.calculateMatchScore(disease.symptoms, symptoms);
          if (matchScore > 0.3) { // Seuil de correspondance
            results.possibleConditions.push({
              name: disease.name,
              probability: `${Math.round(matchScore * 100)}%`,
              matchDetails: this.getTopMatchingSymptoms(disease.symptoms, symptoms)
            });
          }
        });
        
        // Détection des urgences
        if (symptoms.some(s => ["difficultés respiratoires", "douleur thoracique", "saignement abondant"].includes(s))) {
          results.urgency = "URGENCE - Consulter immédiatement";
          results.recommendations = ["APPELER LE 15 ou se rendre aux urgences"];
        }
        
        // Personnalisation selon la durée
        if (durationDays > 7) {
          results.recommendations.push("Consultation recommandée (symptômes prolongés)");
        }
        
        // Ajout des signes d'alerte
        if (symptoms.includes("fièvre") && durationDays > 3) {
          results.warningSigns.push("Fièvre persistante > 3 jours");
        }
        
        return results;
      },
      
      convertToDays: function(value, unit) {
        switch(unit) {
          case 'hours': return value / 24;
          case 'weeks': return value * 7;
          default: return value;
        }
      },
      
      calculateMatchScore: function(diseaseSymptoms, patientSymptoms) {
        const matches = diseaseSymptoms.filter(s => patientSymptoms.includes(s)).length;
        return matches / diseaseSymptoms.length;
      },
      
      getTopMatchingSymptoms: function(diseaseSymptoms, patientSymptoms) {
        return diseaseSymptoms.filter(s => patientSymptoms.includes(s)).slice(0, 3).join(', ');
      },
      
      generateReport: function(data) {
        let html = `<h3>Résultats d'analyse</h3>`;
        
        if (data.possibleConditions.length > 0) {
          html += `<p><strong>Conditions possibles :</strong></p><ul style="margin-left:1.5rem;">`;
          data.possibleConditions.forEach(cond => {
            html += `<li style="margin-bottom:0.5rem;"><strong>${cond.name}</strong> (${cond.probability})<br>
                     <small>Symptômes correspondants : ${cond.matchDetails}</small></li>`;
          });
          html += `</ul>`;
        } else {
          html += `<p>Aucune condition spécifique identifiée.</p>`;
        }
        
        html += `<p><strong>Niveau d'urgence :</strong> <span style="color:${
          data.urgency.includes('URGENCE') ? 'var(--alert)' : 'inherit'
        }">${data.urgency}</span></p>`;
        
        if (data.warningSigns.length > 0) {
          html += `<p><strong>Signes d'alerte :</strong></p><ul style="margin-left:1.5rem;color:var(--alert);">`;
          data.warningSigns.forEach(sign => {
            html += `<li>${sign}</li>`;
          });
          html += `</ul>`;
        }
        
        html += `<p><strong>Recommandations :</strong></p><ol style="margin-left:1.5rem;">`;
        data.recommendations.forEach(rec => {
          html += `<li style="margin-bottom:0.25rem;">${rec}</li>`;
        });
        html += `</ol>`;
        
        return html;
      }
    };
    
    // 4. Chatbot médical
    const medicalChatbot = {
      respond: async function(message) {
        // Vérifier d'abord la base de connaissances
        for (const [keyword, info] of Object.entries(medicalKB)) {
          if (message.toLowerCase().includes(keyword)) {
            return this.formatKBResponse(keyword, info);
          }
        }
        
        // Vérifier les maladies enregistrées
        for (const disease of diseaseManager.diseases) {
          if (message.toLowerCase().includes(disease.name.toLowerCase())) {
            return this.formatDiseaseResponse(disease);
          }
        }
        
        // Réponses spéciales
        if (/urgence|urgent|15|samu/i.test(message)) {
          return this.getEmergencyResponse();
        }
        
        if (/bonjour|salut/i.test(message)) {
          return "Bonjour ! Je suis Dr. IA, votre assistant médical. Comment puis-je vous aider aujourd'hui ?";
        }
        
        if (/sympt[ôo]me|malade|douleur/i.test(message)) {
          return "Pour une analyse précise, décrivez vos symptômes en détail (ex: 'J'ai de la fièvre depuis 2 jours avec des maux de tête').";
        }
        
            // Réponse par défaut
        return "Je suis un assistant médical. Pour vous aider au mieux, veuillez :\n1. Décrire vos symptômes\n2. Précisez leur durée\n3. Mentionnez tout antécédent pertinent\n\nExemple : 'J'ai des douleurs abdominales depuis 3 jours avec diarrhée'";
      },
      
      formatKBResponse: function(keyword, info) {
        let response = `🔍 <strong>${keyword.charAt(0).toUpperCase() + keyword.slice(1)}</strong>\n\n`;
        response += `<em>${info.description}</em>\n\n`;
        
        if (info.causes) {
          response += `📌 <u>Causes possibles</u>:\n- ${info.causes.join('\n- ')}\n\n`;
        }
        
        if (info.actions) {
          response += `💡 <u>Conseils</u>:\n- ${info.actions.join('\n- ')}\n\n`;
        }
        
        if (info.urgent) {
          response += `⚠️ <strong>${info.urgent}</strong>`;
        }
        
        return response;
      },
      
      formatDiseaseResponse: function(disease) {
        let response = `📋 <strong>${disease.name}</strong>\n\n`;
        response += `<u>Symptômes caractéristiques</u>:\n- ${disease.symptoms.join('\n- ')}\n\n`;
        
        const kbInfo = medicalKB[disease.name.toLowerCase()];
        if (kbInfo) {
          if (kbInfo.description) response += `<em>${kbInfo.description}</em>\n\n`;
          if (kbInfo.treatment) response += `💊 <u>Traitement</u>:\n- ${kbInfo.treatment.join('\n- ')}\n\n`;
        }
        
        response += `Pour un diagnostic précis, consultez un professionnel de santé.`;
        return response;
      },
      
      getEmergencyResponse: function() {
        return `🚨 <strong>URGENCES MÉDICALES - COMPOSEZ LE 15</strong>\n\n` +
               `Signes nécessitant une intervention immédiate :\n` +
               `- Douleur thoracique intense\n` +
               `- Difficultés respiratoires\n` +
               `- Trouble de la conscience\n` +
               `- Paralysie brutale\n` +
               `- Hémorragie importante\n\n` +
               `⚠️ <strong>Ne pas attendre</strong>, chaque minute compte !`;
      }
    };
    
    // 5. Interface utilisateur
    const UI = {
      showLoading: function(element, message = 'Analyse en cours...') {
        element.innerHTML = `<div style="text-align:center;padding:1rem;"><em>${message}</em></div>`;
      },
      
      showError: function(element, message) {
        element.innerHTML = `<div style="color:var(--alert);padding:1rem;">${message}</div>`;
      },
      
      scrollToBottom: function(element) {
        setTimeout(() => {
          element.scrollTop = element.scrollHeight;
        }, 100);
      },
      
      enableSave: function(enable) {
        document.getElementById('save-btn').disabled = !enable;
      },
      
      switchTab: function(tabId) {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        
        document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      }
    };
    
    // 6. Fonctions utilitaires
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `fade-in`;
      notification.style.cssText = `
        position: fixed;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? 'var(--success)' : 'var(--alert)'};
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 100;
        max-width: 90%;
        text-align: center;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    // 7. Gestion des événements
    function switchTab(tabId) {
      UI.switchTab(tabId);
    }
    
    function performDiagnosis() {
      // Récupérer les données du formulaire
      const age = document.getElementById('patient-age').value;
      const gender = document.getElementById('patient-gender').value;
      const duration = {
        value: parseInt(document.getElementById('symptom-duration').value) || 1,
        unit: document.getElementById('duration-unit').value
      };
      const history = document.getElementById('medical-history').value;
      
      // Validation
      if (!age || age < 0 || age > 120) {
        showNotification("Veuillez entrer un âge valide", 'warning');
        return;
      }
      
      // Collecter les symptômes
      const symptoms = [];
      document.querySelectorAll('.symptoms-grid input[type="checkbox"]:checked').forEach(checkbox => {
        symptoms.push(checkbox.value);
      });
      
      const otherSymptoms = document.getElementById('other-symptoms').value;
      if (otherSymptoms) symptoms.push(...otherSymptoms.split(',').map(s => s.trim()).filter(s => s));
      
      if (symptoms.length === 0) {
        showNotification("Veuillez sélectionner au moins un symptôme", 'warning');
        return;
      }
      
      // Afficher les résultats
      const resultsDiv = document.getElementById('diagnostic-result');
      UI.showLoading(resultsDiv);
      document.getElementById('results').classList.remove('hidden');
      
      // Simuler un délai d'analyse
      setTimeout(() => {
        try {
          const analysis = diagnosticEngine.analyze(symptoms, duration, history);
          resultsDiv.innerHTML = diagnosticEngine.generateReport(analysis);
          UI.enableSave(true);
          
          // Enregistrer dans l'historique
          patientData.addRecord({
            symptoms: symptoms.join(', '),
            diagnosis: analysis.possibleConditions.map(c => c.name).join(', ') || 'Non spécifié',
            recommendations: analysis.recommendations
          });
          
          showNotification("Diagnostic terminé");
        } catch (error) {
          UI.showError(resultsDiv, "Une erreur s'est produite lors de l'analyse");
          console.error("Erreur d'analyse:", error);
        }
      }, 1500);
    }
    
    function saveDiagnosis() {
      const record = patientData.records[patientData.records.length - 1];
      if (record) {
        showNotification(`Diagnostic enregistré (${record.id})`);
        // En production: envoyer au serveur
      } else {
        showNotification("Aucun diagnostic à enregistrer", 'warning');
      }
    }
    
    function clearForm() {
      document.getElementById('diagnostic-form').reset();
      document.getElementById('other-symptoms').value = '';
      document.getElementById('results').classList.add('hidden');
      UI.enableSave(false);
      showNotification("Formulaire réinitialisé");
    }
    
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      if (!message) return;
      
      const chatContainer = document.getElementById('chat-container');
      
      // Ajouter le message de l'utilisateur
      chatHistory.addMessage('user', message);
      displayMessage(message, 'user');
      input.value = '';
      
      // Afficher "typing"
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator bot-message message';
      typingDiv.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      `;
      chatContainer.appendChild(typingDiv);
      UI.scrollToBottom(chatContainer);
      
      // Obtenir la réponse
      try {
        const response = await medicalChatbot.respond(message);
        chatHistory.addMessage('assistant', response);
        
        // Remplacer "typing" par la réponse
        typingDiv.outerHTML = `<div class="bot-message message fade-in">${response.replace(/\n/g, '<br>')}</div>`;
      } catch (error) {
        console.error("Erreur du chatbot:", error);
        typingDiv.outerHTML = '<div class="bot-message message">Désolé, une erreur s\'est produite</div>';
      }
      
      UI.scrollToBottom(chatContainer);
    }
    
    function displayMessage(message, sender) {
      const chatContainer = document.getElementById('chat-container');
      const messageDiv = document.createElement('div');
      messageDiv.className = `${sender}-message message fade-in`;
      messageDiv.innerHTML = message.replace(/\n/g, '<br>');
      chatContainer.appendChild(messageDiv);
      UI.scrollToBottom(chatContainer);
    }
    
    function toggleDiseaseForm() {
      const form = document.getElementById('disease-form');
      form.classList.toggle('hidden');
      
      if (!form.classList.contains('hidden')) {
        document.getElementById('disease-name').focus();
      }
    }
    
    function addDisease() {
      const name = document.getElementById('disease-name').value;
      const symptoms = document.getElementById('disease-symptoms').value;
      
      if (!name || !symptoms) {
        showNotification("Veuillez remplir tous les champs", 'warning');
        return;
      }
      
      diseaseManager.add(name, symptoms);
      
      // Réinitialiser le formulaire
      document.getElementById('disease-name').value = '';
      document.getElementById('disease-symptoms').value = '';
      toggleDiseaseForm();
    }
    
    // 8. Gestion des données patients
    const patientData = {
      records: JSON.parse(localStorage.getItem('patientRecords')) || [],
      
      addRecord: function(record) {
        const newRecord = {
          ...record,
          id: 'rec_' + Math.random().toString(36).substring(2, 10),
          date: new Date().toISOString(),
          userId: currentUser.id
        };
        
        this.records.push(newRecord);
        localStorage.setItem('patientRecords', JSON.stringify(this.records));
        return newRecord;
      }
    };
    
    // 9. Gestion de l'historique de chat
    const chatHistory = {
      messages: JSON.parse(localStorage.getItem('chatHistory')) || [],
      
      addMessage: function(role, content) {
        this.messages.push({ role, content, timestamp: new Date().toISOString() });
        localStorage.setItem('chatHistory', JSON.stringify(this.messages));
      }
    };
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      // Charger les maladies
      diseaseManager.refreshUI();
      diagnosticEngine.updateDiseases(diseaseManager.diseases);
      
      // Configurer les événements
      document.getElementById('diagnose-btn').addEventListener('click', performDiagnosis);
      document.getElementById('save-btn').addEventListener('click', saveDiagnosis);
      document.getElementById('clear-btn').addEventListener('click', clearForm);
      document.getElementById('send-btn').addEventListener('click', sendMessage);
      document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      // Afficher le premier message du chatbot
      if (chatHistory.messages.length === 0) {
        chatHistory.addMessage('assistant', "Bonjour, je suis Dr. IA. Vous pouvez me décrire vos symptômes ou poser des questions médicales.");
        displayMessage("Bonjour, je suis Dr. IA. Vous pouvez me décrire vos symptômes ou poser des questions médicales.", 'assistant');
      } else {
        // Restaurer l'historique
        chatHistory.messages.forEach(msg => {
          displayMessage(msg.content, msg.role);
        });
      }
      
      UI.enableSave(false);
    });
  </script>
</body>
</html>
